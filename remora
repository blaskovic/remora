#!/usr/bin/env ruby

disable_dbus = ARGV.delete '--no-dbus'
disable_drb = ARGV.delete '--no-drb'

require 'drb' unless disable_drb

unless disable_dbus
  begin
    require File.join(File.dirname(__FILE__), 'dbus-interface')
  rescue LoadError
    disable_dbus = true
  end
end

if ARGV.any?
  if ARGV.delete 'nowplaying'
    DRb.start_service
    begin
      client = DRbObject.new nil, 'druby://localhost:68739'
      info = client.now_playing
      if info
        puts info.to_s
      else
        puts "No song is playing"
      end
    rescue DRb::DRbConnError
      puts "Remora is not running"
    end
    exit
  end

end

require File.join(File.dirname(__FILE__), 'client')
require File.join(File.dirname(__FILE__), 'user')
require File.join(File.dirname(__FILE__), 'playlist')
require File.join(File.dirname(__FILE__), 'song')
require File.join(File.dirname(__FILE__), 'mplayer')
require File.join(File.dirname(__FILE__), 'ui')

client = GrooveShark::Client.new
$session = client.session

client.use_aoss = true if ARGV.delete '--use-aoss'

run_dbus client unless disable_dbus
DRb.start_service 'druby://localhost:68739', client unless disable_drb

load File.join(File.dirname(__FILE__), 'mpd.rb')
Thread.new {
  EventMachine.run {
    EventMachine::start_server "0.0.0.0", 8000, Remora::MPDConnection, client
  }
}

$display = display = client.display = Remora::UI::Display.new(client)

trap 'INT' do
  display.close
  exit
end

begin
  
  def show_login display
    display.focus :login, :user
    display[:login].show!
    display.dirty! :login
  end
  
  display.pane :queue, 1, 1, 20, -15, 'Queue' do
    control :songs, Remora::UI::ListBox, 1, 1, -1, -1 do
      number!
    end
  end
  
  display.pane :threads, 1, -15, 20, -1, 'Threads' do
    control :list, Remora::UI::ListBox, 1, 1, -1, -1 do
      number!
    end
  end
  
  Thread.new {
    loop {
      display[:threads, :list].data = Thread.list.map {|t| t.object_id }
      display.dirty! :threads
      sleep 1
    }
  }

  display.pane :main, 20, 1, -1, -15, 'Search results' do
    control :search, Remora::UI::TextBox, 2, 1, -2, 1 do
      self.label = 'Search'
      self.text = ''
      
      focus!
    end
    control :results, Remora::UI::ListBox, 1, 2, -1, -1 do
      number!
    end
  end

  display.pane :log, 20, -15, -1, -5, 'MPlayer Output' do
    control :output, Remora::UI::ListBox, 2, 1, -2, -1
  end

  display.pane :np, 20, -5, -1, -1, 'Now playing' do
    control :song_name, Remora::UI::Label, 1, 1, -1, 1 do
      align :center
    end
    control :cue, Remora::UI::DoubleProgressBar, 2, 2, -2, 3 do
      template '==>->  '
    end
    control :position, Remora::UI::Label, 1, 3, -1, 3
  end
  
  display[:main, :results].on_submit do |list, song|
    next unless song.is_a? GrooveShark::Song
    
    client.queue << song
    
    unless client.now_playing
      Thread.new do
        begin
          client.queue.play_radio
        rescue => ex
          display.close
          puts ex.class, ex.message, ex.backtrace
          exit
        end
      end
    end
  end
  
  $results = nil
  display[:main, :search].on_submit do |box, query|
    next if query.empty?
	
    if query.to_i.to_s == query && $results
      index = query.to_i - 1
      next if index < 0 || index > $results.size
      
      song = $results[index]
      client.queue << song
      
      unless client.now_playing
        Thread.new do
          begin
            client.queue.play_radio
          rescue => ex
            display.close
            puts ex.class, ex.message, ex.backtrace
            exit
          end
        end
      end
    elsif query == '/pause'
      client.player && client.player.pause
    elsif query == '/stop'
      client.player && client.player.stop
    elsif query == '/login'
      show_login display
    elsif query =~ /^\/player (.+)$/
      client.player && client.player.process.puts($1)
    elsif query =~ /^\/raw ([^ ]+) ([^ ]+) (.*)$/
      $results = nil
      display[:main, :results].data = client.request($1, $2, eval($3)).inspect.lines.to_a.map{|l| l.chomp}
      display[:main].title = "Results for #{$2} to #{$1}"
      display.dirty! :main
    else
      $results = client.search_songs(query)
      display[:main, :results].data = $results
      display[:main].title = "Search Results for #{query}"
      display.dirty! :main
    end
  end

  display.alert :login, 30, 8, 'Login to Grooveshark' do
    hide!
    
    control :user, Remora::UI::TextBox, 3, 2, -3, 2 do
      self.label = 'Username'
      self.text = ''
    end
    control :pass, Remora::UI::TextBox, 3, 4, -3, 4 do
      self.label = 'Password'
      self.text = ''
      self.mask = '*'
    end
    
    control :submit, Remora::UI::Button, 5, 6, 14, 6 do
      self.text = 'Login'
      self.alignment = :center
    end
    control :cancel, Remora::UI::Button, 15, 6, 25, 6 do
      self.text = 'Cancel'
      self.alignment = :center
      
      on_submit do
        display[:login].yank_values # clear the boxes
        display[:login].hide!
        display.focus :main, :search
        display.dirty!
      end
    end
      
    on_submit do
      creds = yank_values
      
      display[:login].hide!
      display.dirty!
      
      client.login creds[:user], creds[:pass]
      
      $results = client.user.favorites
      display[:main, :results].data = $results
      display[:main].title = "Your Favorites"
      
      display.focus :main, :search
      display.dirty!
    end
  end

  display.alert :songinfo, 60, 15, 'Song Info' do
    hide!
    
    control :details, Remora::UI::ListBox, 3, 2, -3, -4
    
    control :queue, Remora::UI::Button, 20, -2, 30, -2 do
      self.text = 'Queue'
      self.alignment = :center
      
      on_submit do
        display[:songinfo].hide!
        display.dirty!
        
        #~ $results = client.user.favorites
        #~ display[:main, :results].data = $results
        #~ display[:main].title = "Your Favorites"
        
        display.focus :main, :search
        display.dirty!
      end
    end
    
    control :close, Remora::UI::Button, 31, -2, 41, -2 do
      self.text = 'Close'
      self.alignment = :center
    end
      
    on_submit do
      display[:songinfo].hide!
      display.focus :main, :search
      display.dirty!
    end
  end

  display.handle while sleep 0.01

rescue => ex
  display.close
  puts ex.class, ex.message, ex.backtrace
  exit
end
